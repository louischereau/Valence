name: Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # 2. Install Rust toolchain
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      # 3. Install uv (tool manager for Python/Rust workflow)
      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          version: "latest"


      # 4. Install system dependencies for Rust build
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libfontconfig1-dev

      # 5. Create virtual environment
      - name: Create virtual environment
        run: uv venv

      # 5. Install required tools
      - name: Install tools
        run: |
          uv tool install maturin       # for building wheels
          uv pip install twine
          uv pip install python-semantic-release==7.34.6


      # 5. Semantic-release: compute version, commit, tag, GitHub release
      - name: Semantic release (version bump + commit + tag)
        working-directory: ${{ github.workspace }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          uv run semantic-release publish \
            -v DEBUG \
            -D commit_author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. Build wheels with maturin (after version bump)
      - name: Build wheels
        run: |
          uv run maturin build --release

      # 7. Upload wheels to GitHub release
      - name: Upload wheels to GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="$(git describe --tags --abbrev=0)"
          gh release upload "$TAG" target/wheels/*.whl --clobber

      # - name: Publish to PyPI
      #   env:
      #     TWINE_USERNAME: __token__
      #     TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      #   run: |
      #     python -m twine upload target/wheels/*.whl
